---
export const prerender = false; // This page uses ISR

import { createClient } from "@supabase/supabase-js";
import BaseLayout from "../../layouts/BaseLayout.astro";

const supabase = createClient(
  "https://xngaipxdnpjswqofnpjr.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhuZ2FpcHhkbnBqc3dxb2ZucGpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3OTcxMzAsImV4cCI6MjA2NTM3MzEzMH0.g1V9H_Kr3musiHJVoU-H4P0YeJlhRoJ1h4TzaHCi5d8"
);

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect("/404");
}

const { data: place, error } = await supabase
  .from("places")
  .select("*")
  .eq("slug", slug)
  .single();

if (error || !place) {
  return Astro.redirect("/404");
}

const pageTitle = `${place.name} - ${place.district || place.city}`;
---

<BaseLayout title={pageTitle} description={place.description_tr || place.name}>
  <div class="mx-auto max-w-7xl px-4 py-8">
    <!-- Breadcrumb -->
    <nav class="mb-6 text-sm text-gray-600">
      <a href="/" class="hover:text-blue-600">Ana Sayfa</a>
      <span class="mx-2">/</span>
      {
        place.city && (
          <>
            <span class="hover:text-blue-600">{place.city}</span>
            <span class="mx-2">/</span>
          </>
        )
      }
      <span class="font-semibold text-gray-700">{place.name}</span>
    </nav>

    <div class="grid grid-cols-1 gap-8 lg:grid-cols-3">
      <div class="lg:col-span-2">
        <!-- Header -->
        <header class="mb-6">
          <h1 class="text-3xl font-bold text-gray-900 mb-2">{place.name}</h1>
          {
            place.description_tr && (
              <p class="text-gray-600">{place.description_tr}</p>
            )
          }
        </header>

        <!-- Images -->
        {
          place.image_urls && place.image_urls.length > 0 && (
            <div class="mb-6">
              <img
                src={place.image_urls[0]}
                alt={`${place.name} fotoğrafı`}
                class="w-full h-96 object-cover rounded-lg"
                loading="eager"
              />
            </div>
          )
        }
      </div>

      <!-- Sidebar -->
      <aside class="space-y-6">
        <!-- Contact Info -->
        <div class="rounded-lg bg-white p-6 shadow-sm">
          <h3 class="text-lg font-semibold mb-4">İletişim Bilgileri</h3>

          {
            place.address && (
              <div class="flex items-start gap-3 mb-3">
                <svg
                  class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                  />
                </svg>
                <span class="text-sm text-gray-700">{place.address}</span>
              </div>
            )
          }

          {
            place.phone_number && (
              <div class="flex items-start gap-3 mb-3">
                <svg
                  class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"
                  />
                </svg>
                <a
                  href={`tel:${place.phone_number}`}
                  class="text-sm text-blue-600 hover:underline"
                >
                  {place.phone_number}
                </a>
              </div>
            )
          }

          {
            place.website_uri && (
              <div class="flex items-start gap-3">
                <svg
                  class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9v-9m0-9v9"
                  />
                </svg>
                <a
                  href={place.website_uri}
                  target="_blank"
                  class="text-sm text-blue-600 hover:underline"
                >
                  Web Sitesi
                </a>
              </div>
            )
          }
        </div>
      </aside>
    </div>
  </div>
</BaseLayout>

<!-- JSON-LD Schema -->
<script
  type="application/ld+json"
  set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "LocalBusiness",
    name: place.name,
    description: place.description_tr,
    address: {
      "@type": "PostalAddress",
      streetAddress: place.address,
      addressLocality: place.district || place.city,
      addressRegion: place.city,
      addressCountry: "TR",
    },
    telephone: place.phone_number,
    url: place.website_uri,
    image: place.image_urls?.[0],
  })}
/>
